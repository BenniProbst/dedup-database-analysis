# =============================================================================
# Dedup Database Analysis - GitLab CI/CD Triple Pipeline
# =============================================================================
# Pipeline 1: LaTeX compilation (auto on .tex/.bib/.cls/.bst changes)
# Pipeline 2: C++ compilation + smoke tests (auto on src/cpp/** changes)
# Pipeline 3: DB experiment (MANUAL trigger only -- production DBs!)
#
# SAFETY: Pipeline 3 uses Samba AD lab user (dedup-lab) and isolated
#         lab schemas (dedup_lab). Customer data is NEVER touched.
#         Lab schemas are created before and dropped after each experiment.
#
# Cluster: 4 Worker Nodes (Intel N97), Talos v1.11.6, K8s v1.34.0
# Storage: Longhorn (Replica 4, thin-provisioned)
# Runner: GitLab K8s Runner (ID 6, tag: kubernetes)
# =============================================================================

stages:
  - latex
  - cpp-build
  - cpp-test
  - experiment-build
  - experiment-run
  - experiment-cleanup

variables:
  PROMETHEUS_URL: http://prometheus.monitoring.svc.cluster.local:9090
  REPLICA_COUNT: "4"
  LAB_SCHEMA: dedup_lab
  DUP_GRADES: "U0,U50,U90"
  SYSTEMS: "postgresql,cockroachdb,redis,kafka,minio"

# =============================================================================
# PIPELINE 1: LaTeX Compilation (auto-triggered on document changes)
# =============================================================================

latex:compile:
  stage: latex
  tags:
    - kubernetes
  image: texlive/texlive:latest
  before_script:
    - cd docs
  script:
    - |
      echo "=== LaTeX Compilation: Triple-Pass Build ==="
      pdflatex -interaction=nonstopmode -halt-on-error doku.tex || true
      bibtex doku || true
      pdflatex -interaction=nonstopmode -halt-on-error doku.tex || true
      pdflatex -interaction=nonstopmode -halt-on-error doku.tex
      ls -lh doku.pdf 2>/dev/null && echo "PDF generated successfully" || echo "ERROR: PDF not generated"
      echo "=== Warnings ==="
      grep -c "Warning" doku.log 2>/dev/null && grep "Warning" doku.log | head -10 || echo "None"
      echo "=== Undefined References ==="
      grep "undefined" doku.log | head -5 || echo "None"
  artifacts:
    paths:
      - docs/doku.pdf
      - docs/doku.log
    expire_in: 30 days
    when: always
  rules:
    - changes:
        - "docs/**/*.tex"
        - "docs/**/*.bib"
        - "docs/**/*.cls"
        - "docs/**/*.bst"
        - "docs/Makefile"

# =============================================================================
# PIPELINE 2: C++ Build + Tests (auto on src/cpp/** changes)
# =============================================================================

.cpp-default: &cpp-default
  tags:
    - kubernetes
  image: gcc:14-bookworm
  before_script:
    - |
      apt-get update -qq
      apt-get install -y -qq cmake libpq-dev libcurl4-openssl-dev \
        libhiredis-dev librdkafka-dev nlohmann-json3-dev \
        libmariadb-dev || true

cpp:build:
  <<: *cpp-default
  stage: cpp-build
  script:
    - |
      echo "=== C++ Build: dedup-integration-test v${CI_COMMIT_SHORT_SHA} ==="
      echo "Compiler: $(gcc --version | head -1)"
      echo "CMake: $(cmake --version | head -1)"

      mkdir -p build && cd build
      cmake ../src/cpp -DCMAKE_BUILD_TYPE=Release

      echo "=== Building dedup-test ==="
      make -j$(nproc) dedup-test 2>&1

      echo "=== Building dedup-smoke-test ==="
      make -j$(nproc) dedup-smoke-test 2>&1

      echo "=== Build artifacts ==="
      ls -lh dedup-test dedup-smoke-test
      file dedup-test
  artifacts:
    paths:
      - build/dedup-test
      - build/dedup-smoke-test
    expire_in: 30 days
  rules:
    - changes:
        - "src/cpp/**/*.cpp"
        - "src/cpp/**/*.hpp"
        - "src/cpp/**/*.h"
        - "src/cpp/CMakeLists.txt"
        - ".gitlab-ci.yml"

cpp:smoke-test:
  <<: *cpp-default
  stage: cpp-test
  needs: ["cpp:build"]
  script:
    - |
      echo "=== Smoke Test: SHA-256 + Dataset Generator + Dry-Run ==="
      chmod +x build/dedup-smoke-test

      # 1. Generate test datasets (100 files per grade, 4K-64K, seed=42)
      echo "--- Step 1: Generate datasets ---"
      build/dedup-smoke-test --generate-data \
        --data-dir /tmp/datasets \
        --num-files 100 \
        --file-size 16384 \
        --seed 42 \
        --dry-run --verbose 2>&1

      # Verify generated files
      echo "--- Dataset verification ---"
      for grade in U0 U50 U90; do
        COUNT=$(ls /tmp/datasets/${grade}/*.dat 2>/dev/null | wc -l)
        SIZE=$(du -sh /tmp/datasets/${grade}/ 2>/dev/null | cut -f1)
        echo "  ${grade}: ${COUNT} files, ${SIZE}"
      done

      # 2. Check for duplicates using SHA-256
      echo "--- Step 2: Verify duplication levels ---"
      for grade in U0 U50 U90; do
        TOTAL=$(ls /tmp/datasets/${grade}/*.dat 2>/dev/null | wc -l)
        UNIQUE=$(sha256sum /tmp/datasets/${grade}/*.dat 2>/dev/null | awk '{print $1}' | sort -u | wc -l)
        DUP_PCT=$(python3 -c "print(round((1 - ${UNIQUE}/${TOTAL}) * 100, 1) if ${TOTAL} > 0 else 0)")
        echo "  ${grade}: ${TOTAL} total, ${UNIQUE} unique, ${DUP_PCT}% duplicates"
      done

      echo "=== Smoke Test PASSED ==="
  rules:
    - changes:
        - "src/cpp/**/*.cpp"
        - "src/cpp/**/*.hpp"
        - "src/cpp/**/*.h"
        - "src/cpp/CMakeLists.txt"
        - ".gitlab-ci.yml"

cpp:full-dry-test:
  <<: *cpp-default
  stage: cpp-test
  needs: ["cpp:build"]
  script:
    - |
      echo "=== Full Dry Test: All Systems x All Grades ==="
      chmod +x build/dedup-smoke-test

      # Generate datasets first
      build/dedup-smoke-test --generate-data \
        --data-dir /tmp/datasets \
        --num-files 50 \
        --seed 42 \
        --dry-run 2>&1

      # Run full experiment simulation
      echo "--- Full experiment (dry-run) ---"
      build/dedup-smoke-test \
        --data-dir /tmp/datasets \
        --results-dir results \
        --dry-run --verbose 2>&1

      echo "--- Results ---"
      cat results/combined_results.json 2>/dev/null | head -100

      echo "--- Help output ---"
      build/dedup-smoke-test --help

      echo "=== Full Dry Test PASSED ==="
  artifacts:
    paths:
      - results/
    expire_in: 7 days
  rules:
    - changes:
        - "src/cpp/**/*.cpp"
        - "src/cpp/**/*.hpp"
        - "src/cpp/**/*.h"
        - "src/cpp/CMakeLists.txt"
        - ".gitlab-ci.yml"

# =============================================================================
# PIPELINE 3: Real DB Experiment (MANUAL trigger only)
# =============================================================================
# SAFETY CONCEPT:
#   - Uses Samba AD lab user (dedup-lab) with restricted permissions
#   - All data goes into isolated lab schemas (dedup_lab / dedup-lab prefix)
#   - Lab schemas are CREATED before experiment and DROPPED after
#   - Customer/production data is NEVER read, modified, or deleted
#   - Each DB system uses its own isolation mechanism:
#     PostgreSQL/CockroachDB: CREATE SCHEMA dedup_lab (separate from public)
#     Redis: Key prefix dedup:* (no SELECT in cluster mode)
#     Kafka: Topic prefix dedup-lab-* (separate from production topics)
#     MinIO: Bucket dedup-lab-* (separate from production buckets)
#     MariaDB/ClickHouse: CREATE DATABASE dedup_lab (separate database)
# =============================================================================

# Step 1: Build the binary for the experiment (self-contained, no dependency
# on Pipeline 2 artifacts which may have expired or not exist)
experiment:build:
  <<: *cpp-default
  stage: experiment-build
  script:
    - |
      echo "=== Experiment Build: dedup-test v${CI_COMMIT_SHORT_SHA} ==="
      echo "Compiler: $(gcc --version | head -1)"
      mkdir -p build && cd build
      cmake ../src/cpp -DCMAKE_BUILD_TYPE=Release
      make -j$(nproc) dedup-test 2>&1
      echo "=== Binary ready ==="
      ls -lh dedup-test
      file dedup-test
  artifacts:
    paths:
      - build/dedup-test
    expire_in: 7 days
  rules:
    - when: manual
      allow_failure: true

# Step 2: Run the actual experiment against production databases
experiment:run:
  <<: *cpp-default
  stage: experiment-run
  needs: ["experiment:build"]
  timeout: 4 hours
  script:
    - |
      echo "================================================================="
      echo "  REAL EXPERIMENT: Dedup Database Analysis"
      echo "  WARNING: Connects to PRODUCTION databases via lab schemas!"
      echo "  Lab user: dedup-lab (Samba AD)"
      echo "  Lab schema: ${LAB_SCHEMA}"
      echo "================================================================="
      echo ""
      echo "Systems: ${SYSTEMS}"
      echo "Grades: ${DUP_GRADES}"
      echo "Replica count: ${REPLICA_COUNT}"
      echo ""

      chmod +x build/dedup-test

      # Step 1: Generate test datasets
      echo "=== Step 1: Generate datasets (500 files x 3 grades) ==="
      build/dedup-test --generate-data \
        --data-dir /tmp/datasets \
        --num-files 500 \
        --seed 42 \
        --verbose 2>&1

      # Verify dataset sizes
      echo "=== Dataset summary ==="
      du -sh /tmp/datasets/*/

      # Step 2: Run experiment (creates lab schemas, inserts, measures, cleans up)
      echo "=== Step 2: Run experiment ==="
      build/dedup-test \
        --data-dir /tmp/datasets \
        --systems "${SYSTEMS}" \
        --grades "${DUP_GRADES}" \
        --lab-schema "${LAB_SCHEMA}" \
        --results-dir results \
        --verbose 2>&1

      echo "=== Step 3: Results ==="
      cat results/combined_results.json | python3 -m json.tool 2>/dev/null | head -200

      echo "=== Per-system results ==="
      ls -la results/*.json 2>/dev/null || echo "No per-system results"
  artifacts:
    paths:
      - results/
    expire_in: 90 days
  rules:
    - when: manual
      allow_failure: true

# Step 3: Cleanup -- drop all lab schemas to leave DBs clean
# Runs automatically after experiment:run, also available as manual trigger
experiment:cleanup:
  <<: *cpp-default
  stage: experiment-cleanup
  needs:
    - job: experiment:build
      artifacts: true
    - job: experiment:run
      optional: true
  script:
    - |
      echo "================================================================="
      echo "  CLEANUP: Dropping all lab schemas"
      echo "  This removes ONLY dedup_lab data, NOT customer data!"
      echo "================================================================="

      chmod +x build/dedup-test

      build/dedup-test \
        --cleanup-only \
        --systems "${SYSTEMS}" \
        --lab-schema "${LAB_SCHEMA}" \
        --verbose 2>&1

      echo "=== Cleanup complete: all lab schemas dropped ==="
  rules:
    - when: manual
      allow_failure: true
